---
title: "Single Counts & Proportions"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(mosaicData)
library(tidyverse)
library(ggformula)
library(statPREP)
knitr::opts_chunk$set(echo = FALSE)
```

## Counts and proportions

You can generate a one-way count with the `mtally()` function:

```{r mtally0, exercise = TRUE}
KidsFeet %>% mtally( ~ sex)
```

The one-sided formula specifies the categorical variable to be used for the count.

If you want proportions rather than counts, add the argument `format = "proportion".

```{r mtally1, exercise = TRUE}
KidsFeet %>% 
  mtally( ~ sex, format = "proportion")
```

## One-way Chi-squared

The one-way chi-squared test compares *counts* to a theoretical probability distribution. To perform a chi-squared test, pipe the output of `mtally()` into `chisq.test()`:

```{r mtally3, exercise = TRUE}
KidsFeet %>% 
  mtally( ~ sex) %>%
  chisq.test()
```

By default, `chisq.test()` tests whether the different categories in the count (girls and boys, here) are equally likely.  You can also specify that null probability explicitly, as here where we look to see if the count is consistent with a class of two-thirds girls.

```{r mtally4, exercise = TRUE}
KidsFeet %>%
  mtally( ~ sex) %>%
  chisq.test(p = c(1/3, 2/3))
```

How are you to know that this is one-third boys and two-thirds girls and not the other way around? R will take the levels of a categorical variable in alphabetical order. Since B preceeds G, the boys come first. You can see this in the output of the `mtally()` command:

```{r mtally6, exercise = TRUE}
KidsFeet %>% 
  mtally( ~ sex)
```

Be sure to make the order of the entries in `p` the same as that produced by `mtally()`.

### Exercise

Are the counts of girls and boys in `KidsFeet` consistent with a class that is two-thirds boys?

```{r mtally5, exercise = TRUE}

```

<div id = "mtally5-hint">
In specifying the `p` argument to `chisq.test()` you'll want to put the 2/3 in the boy's slot, which is the first one. (B comes before G.)
</div>


## Use data tables!

You know this sort of textbook problem:

> *In a poll of 509 randomly selected people, 246 respondants indicated support for candidate A. What is the 95% confidence interval on the proportion of the population who support candidate A?*

Before you start calculating quantities like $\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$, think about the problem from a basic data-science point of view. In particular, what are the data? What are the variables? What are the cases?

Rather than 509 and 246 being data, they are really a *data presentation*. The point of the problem is to transform one presentation into another: given $n$ and $\hat{p}$, produce a confidence interval.


Once you get the hang of the software, you will want to use it even for textbook problems based on data presentations rather than data tables. Anticipating this, here's how to do the above problem just with the counts.

```{r with-counts, exercise = TRUE}
prop.test(246, 509)
```

Better to start with an actual data table. In addition to making clearer what the unit of observation is, showing a data table provides a chance to incorporate potential explanatory variables for the support of A.


## Once again, with data

```{r create_data}
set.seed(101)
.A <- tibble(candidate = rep("A", 246), 
            sex = ifelse(runif(246) > .6, "F", "M"),
            age = round(runif(246, min = 18, max = 86)))
.B <- tibble(candidate = rep("B", 263-112), 
            sex = ifelse(runif(263-112) > .3, "F", "M"),
            age = round(runif(263-112, min = 27, max = 90))) 
.C <- tibble(candidate = rep("C", 112),
            sex = ifelse(runif(112) > .45, "F", "M"),
            age = round(20 + rexp(112, rate = 1/15)))
Poll_data <- bind_rows(.A, .B, .C) %>% sample_n(size = 509)
```

```{r ref.label = "create_data"}
# make the above available when knitting
```
For instance, the polling data might look like this:

```{r}
Poll_data
```

The calculation of the confidence interval of the proportion supporting A, if that's what you want, is a simple application of the confidence interval on the mean.

```{r candidateA, exercise = TRUE, exercise.setup = "create_data"}
Poll_data %>%
  qstats(~ candidate == "A", mean.conf)
```

It might surprise you to see inference on the sample proportion being a special case of inference on the mean. What makes the case special is that `candidate == "A"` is producing a variable whose value is 1 for those supporting A and zero otherwise.

You might like this generalization or you might not. It's perfectly reasonable to stick with the traditional approach when calculating the confidence interval on a single proportion.

But if you play the long game, you should keep in mind three of the GAISE recommendations:

* Give students experience with multivariable thinking.
* Integrate real data with a context and purpose.
* Teach statistics as an investigative process of problem-solving and decision-making.

Starting with data tables rather than data presentations has some advantages down the line. For instance, you can use the data to investigate other patterns that might be of interest such as how support for a candidate depends on age and sex.

### Going further

In the `qstats()` calculation above, replace the formula in the command with `candidate == "A" ~ sex`. What is the result telling you?

